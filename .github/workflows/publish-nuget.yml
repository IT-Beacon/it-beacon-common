name: Publish NuGet Package

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - uses: actions/checkout@v4

      # 2. Setup .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # 3. Authenticate with GitHub Packages
      - name: Add GitHub Packages source
        run: dotnet nuget add source \
          --username ${{ github.actor }} \
          --password ${{ secrets.NUGET_AUTH_TOKEN }} \
          --store-password-in-clear-text \
          --name github \
          "https://nuget.pkg.github.com/IT-Beacon/index.json"

      # 4. Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # 5. Build the project
      - name: Build
        run: dotnet build --configuration Release --no-restore

      # 6. Pack NuGet package
      - name: Pack
        run: dotnet pack --configuration Release --no-build --output ./artifacts

      # 7. List artifacts for debugging
      - name: List artifacts
        run: ls -R artifacts

      # 8. Push to GitHub Packages
      - name: Push to GitHub Packages
        run: dotnet nuget push "artifacts/*.nupkg" --source "github" --api-key ${{ secrets.NUGET_AUTH_TOKEN }}
